#!/bin/bash

# gvm::current gets the current version of Go
eunomia::prepare() {
  # BUILD
  export PLUGIN_EUNOMIA_BUILD_ID=${PLUGIN_EUNOMIA_BUILD_ID}
  # export PLUGIN_EUNOMIA_BUILD_HASH=${PLUGIN_EUNOMIA_BUILD_HASH}

  # export PLUGIN_EUNOMIA_BUILD_HASH=$(md5sum $PLUGIN_EUNOMIA_GIT_REPO_PKG | awk -F " " '{print $1}')
  export PLUGIN_EUNOMIA_BUILD_ID_DIR=${PLUGIN_EUNOMIA_BUILD_DIR}/${PLUGIN_EUNOMIA_BUILD_ID}
  export PLUGIN_EUNOMIA_GIT_REPO_DIR=$PLUGIN_EUNOMIA_GIT_DIR/$PLUGIN_EUNOMIA_BUILD_ID
  export PLUGIN_EUNOMIA_GIT_DOT_ENV=$PLUGIN_EUNOMIA_GIT_REPO_DIR/.eunomia

  export PLUGIN_EUNOMIA_GIT_REPO_NAME=${PLUGIN_EUNOMIA_GIT_REPO_NAME}
  export PLUGIN_EUNOMIA_GIT_REPO_PKG=${PLUGIN_EUNOMIA_GIT_REPO_PKG}

  export PLUGIN_EUNOMIA_DOCKER_REGISTRY=${PLUGIN_EUNOMIA_DOCKER_REGISTRY:-"docker-ta.thinkingdata.cn"}
  export PLUGIN_EUNOMIA_EXPORT_DIR=${PLUGIN_EUNOMIA_EXPORT_DIR}

  # # PIPELINE
  # export PIPELINE_BUILD_ID=${PLUGIN_EUNOMIA_BUILD_ID}
  # export PIPELINE_BUILD_CONTEXT=$PLUGIN_EUNOMIA_BUILD_ID_DIR
  # export PIPELINE_GIT_REPOSITORY_DIR=$PLUGIN_EUNOMIA_GIT_REPO_DIR
  # export PIPELINE_DOCKER_REGISTRY=$PLUGIN_EUNOMIA_DOCKER_REGISTRY
  # export PIPELINE_IMAGE_NAME=$PLUGIN_EUNOMIA_GIT_REPO_NAME
  # export PIPELINE_IMAGE_TAGS=build_${PLUGIN_EUNOMIA_BUILD_ID}

  # EXPORT
  export PLUGIN_EUNOMIA_EXPORT_DIR=${PLUGIN_EUNOMIA_EXPORT_DIR:-"$PLUGIN_EUNOMIA_BUILD_ID_DIR/dist"}
  #
  export PLUGIN_EUNOMIA_RUNNER_NAME=zpipeline_eunomia_${PLUGIN_EUNOMIA_BUILD_ID}
  # export PLUGIN_EUNOMIA_RUNNER_IMAGE=$PLUGIN_EUNOMIA_DOCKER_REGISTRY/$PIPELINE_IMAGE_NAME:$PIPELINE_IMAGE_TAGS

  if [ ! -d "$PLUGIN_EUNOMIA_GIT_DIR" ]; then
    mkdir -p $PLUGIN_EUNOMIA_GIT_DIR
  fi

  if [ ! -d "$PLUGIN_EUNOMIA_BUILD_DIR" ]; then
    mkdir -p $PLUGIN_EUNOMIA_BUILD_DIR
  fi

  if [ -z "$PLUGIN_EUNOMIA_BUILD_ID" ]; then
    log::error "[prepare] PLUGIN_EUNOMIA_BUILD_ID is required"
    exit 1
  fi

  if [ -z "$PLUGIN_EUNOMIA_GIT_REPO_NAME" ]; then
    log::error "[prepare] PLUGIN_EUNOMIA_GIT_REPO_NAME is required"
    exit 1
  fi

  if [ -z "$PLUGIN_EUNOMIA_GIT_REPO_PKG" ]; then
    log::error "[prepare] PLUGIN_EUNOMIA_GIT_REPO_PKG is required"
    exit 1
  fi

  if [ ! -f "$PLUGIN_EUNOMIA_GIT_REPO_PKG" ]; then
    log::error "[prepare] PLUGIN_EUNOMIA_GIT_REPO_PKG($PLUGIN_EUNOMIA_GIT_REPO_PKG) is not a file"
    exit 1
  fi

  mkdir -p $PLUGIN_EUNOMIA_GIT_REPO_DIR
  # mkdir -p $PLUGIN_EUNOMIA_BUILD_ID_DIR


    if [ -d "$PLUGIN_EUNOMIA_BUILD_ID_DIR" ]; then
    rm -rf $PLUGIN_EUNOMIA_BUILD_ID_DIR
  fi
  
  # PIPELINE
  export PIPELINE_BUILD_ID=${PLUGIN_EUNOMIA_BUILD_ID}
  export PIPELINE_BUILD_CONTEXT=$PLUGIN_EUNOMIA_BUILD_ID_DIR
  export PIPELINE_GIT_REPOSITORY_DIR=$PLUGIN_EUNOMIA_GIT_REPO_DIR
  export PIPELINE_DOCKER_REGISTRY=$PLUGIN_EUNOMIA_DOCKER_REGISTRY
  export PIPELINE_IMAGE_NAME=$PLUGIN_EUNOMIA_GIT_REPO_NAME
  export PIPELINE_IMAGE_TAGS=build_${PLUGIN_EUNOMIA_BUILD_HASH:-${PLUGIN_EUNOMIA_BUILD_ID}}

  # APP
  if [ -z "$(ls $PLUGIN_EUNOMIA_GIT_REPO_DIR)" ]; then
    tar -zxvf $PLUGIN_EUNOMIA_GIT_REPO_PKG -C $PLUGIN_EUNOMIA_GIT_REPO_DIR
  fi

  # check env .eunomia
  if [ -f "$PLUGIN_EUNOMIA_GIT_DOT_ENV" ]; then
    dotenv::load $PLUGIN_EUNOMIA_GIT_DOT_ENV
    if [ -n "$PLUGIN_EUNOMIA_BUILD_HASH" ] || [ -n "$PIPELINE_BUILD_HASH" ]; then
      export PIPELINE_IMAGE_TAGS=build_${PLUGIN_EUNOMIA_BUILD_HASH:-${PIPELINE_BUILD_HASH}}
      export PLUGIN_EUNOMIA_RUNNER_IMAGE=$PLUGIN_EUNOMIA_DOCKER_REGISTRY/$PIPELINE_IMAGE_NAME:$PLUGIN_EUNOMIA_BUILD_HASH
    fi
  fi
}

export -f eunomia::prepare
