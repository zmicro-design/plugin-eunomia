#!/bin/bash

eunomia::build() {
  if [ -z "$PLUGIN_EUNOMIA_GIT_REPO_DIR" ]; then
    log::error "[eunomia::build] PLUGIN_EUNOMIA_GIT_REPO_DIR is required"
    return 1
  fi

  if [ ! -d "$PLUGIN_EUNOMIA_GIT_REPO_DIR" ]; then
    log::error "[eunomia::build] PLUGIN_EUNOMIA_GIT_REPO_DIR($PLUGIN_EUNOMIA_GIT_REPO_DIR) not found, you must run prepare first"
    return 1
  fi

  # Dockerfile
  cp ${PLUGIN_EUNOMIA_GIT_REPO_DOCKERFILE} $PLUGIN_EUNOMIA_GIT_REPO_DIR

  # ADD build files for dockerfile
  echo "EUNOMIA_GIT_REPO_URL: $EUNOMIA_GIT_REPO_URL" >$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "EUNOMIA_GIT_REPO_NAME: $EUNOMIA_GIT_REPO_NAME" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "EUNOMIA_GIT_BRANCH: $EUNOMIA_GIT_BRANCH" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "EUNOMIA_GIT_COMMIT_ACTOR: $EUNOMIA_GIT_COMMIT_ACTOR" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "EUNOMIA_GIT_COMMIT: $EUNOMIA_GIT_COMMIT" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "EUNOMIA_GIT_COMMIT_TIMESTAMP: $EUNOMIA_GIT_COMMIT_TIMESTAMP" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  #
  echo "EUNOMIA_EXECUTOR_NAME: $EUNOMIA_EXECUTOR_NAME" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "EUNOMIA_EXECUTOR_EMAIL: $EUNOMIA_EXECUTOR_EMAIL" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "EUNOMIA_EXECUTOR_ID: $EUNOMIA_EXECUTOR_ID" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  #
  echo "EUNOMIA_BUILD_ID: $EUNOMIA_BUILD_ID" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "EUNOMIA_BUILD_HASH: $EUNOMIA_BUILD_HASH" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js

  #
  echo "$PLUGIN_EUNOMIA_BUILD_ID" >$PLUGIN_EUNOMIA_GIT_REPO_DIR/buildid.eunomia.js
  echo "$(date)" >$PLUGIN_EUNOMIA_GIT_REPO_DIR/buildtime.eunomia.js

  zmicro pipeline bp
  if [ "$?" != "0" ]; then
    log::error "[eunomia::build] failed to build"
    return 1
  fi
  
  log::info "[eunomia::build] done"
}

export -f eunomia::build
