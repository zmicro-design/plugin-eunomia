#!/bin/bash

eunomia::build() {
  if [ -z "$PLUGIN_EUNOMIA_GIT_REPO_DIR" ]; then
    log::error "[eunomia::build] PLUGIN_EUNOMIA_GIT_REPO_DIR is required"
    exit 1
  fi

  if [ ! -d "$PLUGIN_EUNOMIA_GIT_REPO_DIR" ]; then
    log::error "[eunomia::build] you must run prepare first"
    exit 1
  fi

  # Dockerfile
  cp ${PLUGIN_EUNOMIA_GIT_REPO_DOCKERFILE} $PLUGIN_EUNOMIA_GIT_REPO_DIR

  # ADD build files for dockerfile
  echo "GIT_REPO_URL: $GIT_REPO_URL" >$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "GIT_REPO_NAME: $GIT_REPO_NAME" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "GIT_BRANCH: $GIT_BRANCH" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "GIT_COMMIT_ACTOR: $GIT_COMMIT_ACTOR" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "GIT_COMMIT: $GIT_COMMIT" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "GIT_COMMIT_TIMESTAMP: $GIT_COMMIT_TIMESTAMP" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  #
  echo "PIPELINE_EXECUTOR_NAME: $PIPELINE_EXECUTOR_NAME" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "PIPELINE_EXECUTOR_EMAIL: $PIPELINE_EXECUTOR_EMAIL" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "PIPELINE_EXECUTOR_ID: $PIPELINE_EXECUTOR_ID" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  #
  echo "PIPELINE_ID: $PIPELINE_ID" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "PIPELINE_BUILD_ID: $PIPELINE_BUILD_ID" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js
  echo "PIPELINE_BUILD_HASH: $PIPELINE_BUILD_HASH" >>$PLUGIN_EUNOMIA_GIT_REPO_DIR/build.eunomia.js

  #
  echo "$PLUGIN_EUNOMIA_BUILD_ID" >$PLUGIN_EUNOMIA_GIT_REPO_DIR/buildid.eunomia.js
  echo "$(date)" >$PLUGIN_EUNOMIA_GIT_REPO_DIR/buildtime.eunomia.js

  zmicro pipeline bp

  log::info "[eunomia::build] done"
}

export -f eunomia::build
