#!/bin/bash

eunomia::deploy() {
  # @1
  if [ -f "${EUNOMIA_DEPLOY_SCRIPT}" ]; then
    export EUNOMIA_DEPLOY_MODE="script"
  fi

  case $EUNOMIA_DEPLOY_MODE in
    script)
      log::info "[$(timestamp)][eunomia::deploy] start to deploy script ..."
      eunomia::deploy_script
      if [ "$?" != "0" ]; then
        log::error "[$(timestamp)][eunomia::deploy] failed to deploy script"
        return 1
      fi

      log::success "[$(timestamp)][eunomia::deploy] succeed to deploy script"
      return 0
      ;;
    service)
      log::info "[$(timestamp)][eunomia::deploy] start to deploy service ..."
      eunomia::deploy_service
      if [ "$?" != "0" ]; then
        log::error "[$(timestamp)][eunomia::deploy] failed to deploy service"
        return 1
      fi

      log::success "[$(timestamp)][eunomia::deploy] succeed to deploy service"
      ;;
    component)
      log::info "[$(timestamp)][eunomia::deploy] start to deploy component ..."
      eunomia::deploy_component
      if [ "$?" != "0" ]; then
        log::error "[$(timestamp)][eunomia::deploy] failed to deploy component"
        return 1
      fi

      log::success "[$(timestamp)][eunomia::deploy] succeed to deploy component"
      ;;
    *)
      log::error "[$(timestamp)][eunomia::deploy] unsupport deploy mode: $EUNOMIA_DEPLOY_MODE"
      ;;
  esac
}

eunomia::deploy_script() {
  if [ -z "$EUNOMIA_DEPLOY_HOST" ]; then
    log::error "[eunomia::deploy_script] EUNOMIA_DEPLOY_HOST is required"
    return 1
  fi

  if [ ! -f "$EUNOMIA_DEPLOY_SCRIPT" ]; then
    log::error "[eunomia::deploy_script] EUNOMIA_DEPLOY_SCRIPT is required"
    return 1
  fi

  if [ ! -f "$EUNOMIA_BUILD_ENV_SHELL" ]; then
    log::error "[eunomia::deploy_script] EUNOMIA_BUILD_ENV_SHELL is required"
    return 1
  fi

  log::info "[$(timestamp)][eunomia::deploy_script] start to execute ..."
  gzcaas client \
    -s ${EUNOMIA_DEPLOY_HOST} \
    --scriptfile ${EUNOMIA_DEPLOY_SCRIPT} \
    --envfile ${EUNOMIA_BUILD_ENV_SHELL}
  if [ "$?" != "0" ]; then
    log::error "[$(timestamp)][eunomia::deploy_script] failed to execute"
    return 1
  fi

  log::success "[$(timestamp)][eunomia::deploy_script] succeed to execute"
}

eunomia::deploy_service() {
  # config
  if [ -z "$PLUGIN_EUNOMIA_DOCKER_REGISTRY" ]; then
    log::error "[eunomia::deploy_service] PLUGIN_EUNOMIA_DOCKER_REGISTRY is required"
    return 1
  fi

  if [ -z "$PLUGIN_EUNOMIA_CONFIG_CENTER" ]; then
    log::error "[eunomia::deploy_service] PLUGIN_EUNOMIA_CONFIG_CENTER is required"
    return 1
  fi

  if [ -z "$PLUGIN_EUNOMIA_CONFIG_CENTER_CLIENT_ID" ]; then
    log::error "[eunomia::deploy_service] PLUGIN_EUNOMIA_CONFIG_CENTER_CLIENT_ID is required"
    return 1
  fi

  if [ -z "$PLUGIN_EUNOMIA_CONFIG_CENTER_CLIENT_SECRET" ]; then
    log::error "[eunomia::deploy_service] PLUGIN_EUNOMIA_CONFIG_CENTER_CLIENT_SECRET is required"
    return 1
  fi

  # dynamic runner
  if [ -z "$EUNOMIA_GIT_REPOSITORY" ]; then
    log::error "[eunomia::deploy_service] EUNOMIA_GIT_REPOSITORY is required"
    return 1
  fi

  if [ -z "$EUNOMIA_GIT_COMMIT" ]; then
    log::error "[eunomia::deploy_service] EUNOMIA_GIT_COMMIT is required"
    return 1
  fi

  if [ -z "$EUNOMIA_TASK_ID" ]; then
    log::error "[eunomia::deploy_service] EUNOMIA_TASK_ID is required"
    return 1
  fi

  #
  export PLUGIN_EUNOMIA_DEPLOYMENT_IMAGE_NAME=$(echo ${EUNOMIA_GIT_REPOSITORY#http://10.27.249.150:8888/})

  # DOCKER_HOST
  case $EUNOMIA_DEPLOYMENT_ENV in
  "dev")
    export DOCKER_HOST=$EUNOMIA_DEPLOYMENT_DEV_DOCKER_HOST
    export PLUGIN_EUNOMIA_DEPLOYMENT_NAME=eunomia_deployment_dev_${EUNOMIA_TASK_ID}

    # custom domain name
    #   pattern: {CUSTOM_DOMAIN_NAME}-dev.example.com
    if [ -n "$EUNOMIA_DEPLOYMENT_CUSTOM_DOMAIN_NAME" ]; then
      export PLUGIN_EUNOMIA_DEPLOYMENT_NAME=eunomia_deployment_dev_${EUNOMIA_DEPLOYMENT_CUSTOM_DOMAIN_NAME}
    fi
    ;;
  "prod")
    export DOCKER_HOST=$EUNOMIA_DEPLOYMENT_PROD_DOCKER_HOST
    export PLUGIN_EUNOMIA_DEPLOYMENT_NAME=eunomia_deployment_prod_${EUNOMIA_TASK_ID}

    # custom domain name
    #   pattern: {CUSTOM_DOMAIN_NAME}.example.com
    if [ -n "$EUNOMIA_DEPLOYMENT_CUSTOM_DOMAIN_NAME" ]; then
      export PLUGIN_EUNOMIA_DEPLOYMENT_NAME=eunomia_deployment_prod_${EUNOMIA_DEPLOYMENT_CUSTOM_DOMAIN_NAME}
    fi
    ;;
  *)
    log::error "[$(timestamp)][eunomia::deploy_service] unknown EUNOMIA_DEPLOYMENT_ENV: $EUNOMIA_DEPLOYMENT_ENV"
    return 1
    ;;
  esac

  # env shell
  export EUNOMIA_BUILD_ENV_SHELL=$EUNOMIA_DEPLOYMENT_ENV_SHELL
  log::info "[$(timestamp)][eunomia::deploy_service] start to generate deployment env shell at ${EUNOMIA_BUILD_ENV_SHELL} ..."
  plugin::run_zx env_shell
  if [ "$?" != "0" ]; then
    log::error "[$(timestamp)][eunomia::deploy_service] failed to generate deployment env shell at ${EUNOMIA_BUILD_ENV_SHELL}."
    return 1
  fi
  log::success "[$(timestamp)][eunomia::deploy_service] succeed to generate deployment env shell at ${EUNOMIA_BUILD_ENV_SHELL} ..."

  # env config
  # @TODO avoid docker-compose env file error when file not found
  echo > $EUNOMIA_DEPLOYMENT_ENV_CONFIG
  #
  if [ -n "$EUNOMIA_DEPLOYMENT_CONFIG_ID" ]; then
    log::info "[$(timestamp)][eunomia::deploy_service] start to generate deployment env config at ${EUNOMIA_DEPLOYMENT_ENV_CONFIG} ..."
    plugin::run_zx env_config
    if [ "$?" != "0" ]; then
      log::error "[$(timestamp)][eunomia::deploy_service] failed to generate deployment env config at ${EUNOMIA_DEPLOYMENT_ENV_CONFIG}."
      return 1
    fi
    log::success "[$(timestamp)][eunomia::deploy_service] succeed to generate deployment env config at ${EUNOMIA_DEPLOYMENT_ENV_CONFIG} ..."
  fi

  #
  export PLUGIN_EUNOMIA_DEPLOYMENT_DATA_DIR=${EUNOMIA_DEPLOYMENT_DIR}/data
  export PLUGIN_EUNOMIA_DEPLOYMENT_CONFIG_DIR=${EUNOMIA_DEPLOYMENT_DIR}/configs
  export PLUGIN_EUNOMIA_DEPLOYMENT_LOG_DIR=${EUNOMIA_DEPLOYMENT_DIR}/logs
  if [ ! -d "$PLUGIN_EUNOMIA_DEPLOYMENT_DATA_DIR" ]; then
    mkdir -p $PLUGIN_EUNOMIA_DEPLOYMENT_DATA_DIR
  fi
  if [ ! -d "$PLUGIN_EUNOMIA_DEPLOYMENT_CONFIG_DIR" ]; then
    mkdir -p $PLUGIN_EUNOMIA_DEPLOYMENT_CONFIG_DIR
  fi
  if [ ! -d "$PLUGIN_EUNOMIA_DEPLOYMENT_LOG_DIR" ]; then
    mkdir -p $PLUGIN_EUNOMIA_DEPLOYMENT_LOG_DIR
  fi
  # ERROR_LOG
  export PLUGIN_EUNOMIA_DEPLOYMENT_DEPLOY_LOG=${PLUGIN_EUNOMIA_DEPLOYMENT_LOG_DIR}/deploy.log
  export PLUGIN_EUNOMIA_DEPLOYMENT_ERROR_LOG=${PLUGIN_EUNOMIA_DEPLOYMENT_LOG_DIR}/error.log

  # COMPOSE
  export COMPOSE_PROJECT_NAME=$PLUGIN_EUNOMIA_DEPLOYMENT_NAME

  # generate manifest file from template
  export COMPOSE_FILE=$PLUGIN_CONFIG_DIR/templates/docker-compose.deployment.${EUNOMIA_DEPLOYMENT_MODE}.yml
  if [ ! -f "$COMPOSE_FILE" ]; then
    log::error "[$(timestamp)][eunomia::deploy_service] unsupport deployment mode: ${EUNOMIA_DEPLOYMENT_MODE}"
    return 1
  fi

  docker-compose config > $EUNOMIA_DEPLOYMENT_MANIFEST_FILE
  # service manifest file
  export COMPOSE_FILE=$EUNOMIA_DEPLOYMENT_MANIFEST_FILE

  log::info "[$(timestamp)][eunomia::deploy_service] Environment: ${EUNOMIA_DEPLOYMENT_ENV}"
  # log::info "[$(timestamp)][eunomia::deploy_service] Docker Service at: ${DOCKER_HOST:-Current_Host}"

  local tmp_error=$(os::tmp_file)
  log::info "[$(timestamp)][eunomia::deploy_service] start to deploy ..."
  docker-compose up --detach --remove-orphans # 2>$tmp_error
  if [ "$?" != "0" ]; then
    log::error "[$(timestamp)][eunomia::deploy_service] failed to deploy."
    cat $tmp_error
    cat $tmp_error >>$PLUGIN_EUNOMIA_DEPLOYMENT_ERROR_LOG
    return 1
  fi

  log::success "[$(timestamp)][eunomia::deploy_service] succeed to deploy."
}

# @TO_IMPLEMENT
eunomia::deploy_component() {
  # module_name: EUNOMIA_DEPLOY_COMPONENT_MODULE_NAME
  #
  # version_type: EUNOMIA_DEPLOY_COMPONENT_VERSION_TYPE
  # cluster_version: EUNOMIA_DEPLOY_COMPONENT_CLUSTER_VERSION
  # os: EUNOMIA_DEPLOY_COMPONENT_OS
  # cpu_arch: EUNOMIA_DEPLOY_COMPONENT_CPU_ARCH

  # 1. upload file with os::oss_upload
  log::info "[$(timestamp)][eunomia::deploy_component] start to upload oss ..."

  # 1.1 generate oss path
  log::info "[$(timestamp)][eunomia::deploy_component] generate oss path ..."

  # 1.2 upload file: PLUGIN_EUNOMIA_EXPORT_ID_PKG
  log::info "[$(timestamp)][eunomia::deploy_component] upload file to oss  ..."

  # 2. create a version release record
  log::info "[$(timestamp)][eunomia::deploy_component] create a version release record ..."

  return 1
}

export -f eunomia::deploy

export -f eunomia::deploy_script
export -f eunomia::deploy_service
export -f eunomia::deploy_component
