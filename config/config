export PLUGIN_EUNOMIA_NAME=gvm

####### BASE #######
export PLUGIN_EUNOMIA_GIT_DIR=${PLUGIN_DATA}/git/repo
export PLUGIN_EUNOMIA_BUILD_DIR=${PLUGIN_DATA}/build
export PLUGIN_EUNOMIA_EXPORT_DIR=${PLUGIN_DATA}/export
export PLUGIN_EUNOMIA_LOG_DIR=${PLUGIN_DATA}/log
#######
# Git Repo PKG TMP DIR
export PLUGIN_EUNOMIA_TMP_DIR=${PLUGIN_DATA}/tmp
# Dockerfiles
export PLUGIN_EUNOMIA_DOCKERFILES_DIR=${PLUGIN_DIR}/config/dockerfiles
export PLUGIN_EUNOMIA_DOCKER_CONTAINER_PREFIX=zmicro_plugin_eunomia_
# Service
export PLUGIN_EUNOMIA_SERVICE_NAME=zmicro_plugin_eunomia
export PLUGIN_EUNOMIA_SERVICE_PORT=${PLUGIN_EUNOMIA_SERVICE_PORT:-9000}
# Docker
export PLUGIN_EUNOMIA_DOCKER_REGISTRY=${PLUGIN_EUNOMIA_DOCKER_REGISTRY:-"docker.io"}
# Queue
export PLUGIN_EUNOMIA_TASK_QUEUE_IS_ENABLED=${PLUGIN_EUNOMIA_TASK_QUEUE_IS_ENABLED:-"true"}
export PLUGIN_EUNOMIA_TASK_QUEUE_COCURRENCY=${PLUGIN_EUNOMIA_TASK_QUEUE_COCURRENCY:-"6"}
export PLUGIN_EUNOMIA_TASK_QUEUE_LOCK=${PLUGIN_EUNOMIA_TASK_QUEUE_LOCK:-"/tmp/zmicro_plugin_eunomia_task_queue.lock"}

####### Build #######
# Download
export PLUGIN_EUNOMIA_DOWNLOAD_PKG=${PLUGIN_EUNOMIA_DOWNLOAD_PKG:-$EUNOMIA_DOWNLOAD_PKG}
# @COMPITIBLE
if [ -z "$PLUGIN_EUNOMIA_DOWNLOAD_PKG" ]; then
  export PLUGIN_EUNOMIA_DOWNLOAD_PKG=${PLUGIN_EUNOMIA_DOWNLOAD_GIT_PKG:-$EUNOMIA_DOWNLOAD_GIT_PKG}
fi
# BUILD
export PLUGIN_EUNOMIA_BUILD_GIT_DIR=$PLUGIN_EUNOMIA_GIT_DIR/$PLUGIN_EUNOMIA_BUILD_ID
export PLUGIN_EUNOMIA_BUILD_GIT_DOT_ENV=$PLUGIN_EUNOMIA_BUILD_GIT_DIR/.eunomia
#
export PLUGIN_EUNOMIA_BUILD_ID=${PLUGIN_EUNOMIA_BUILD_ID:-$EUNOMIA_BUILD_ID}
export PLUGIN_EUNOMIA_BUILD_TIMESTAMP=${PLUGIN_EUNOMIA_BUILD_TIMESTAMP:-$(date)}
export PLUGIN_EUNOMIA_BUILD_ID_DIR=$PLUGIN_EUNOMIA_BUILD_DIR/$PLUGIN_EUNOMIA_BUILD_ID
export PLUGIN_EUNOMIA_BUILD_GIT_PKG=${PLUGIN_EUNOMIA_GIT_DIR}/$PLUGIN_EUNOMIA_BUILD_ID.tar.gz
# LOG
export PLUGIN_EUNOMIA_BUILD_ID_LOG=$PLUGIN_EUNOMIA_BUILD_ID_DIR/log.eunomia
# EXPORT
export PLUGIN_EUNOMIA_EXPORT_RUNNER_NAME=${PLUGIN_EUNOMIA_DOCKER_CONTAINER_PREFIX}${PLUGIN_EUNOMIA_BUILD_ID}
export PLUGIN_EUNOMIA_EXPORT_DISABLE=${PLUGIN_EUNOMIA_EXPORT_DISABLE:-"false"}
# 指定容器构建产物目录，默认是 /var/www/html
export PLUGIN_EUNOMIA_EXPORT_RUNNER_DIST_DIR=${PLUGIN_EUNOMIA_EXPORT_RUNNER_DIST_DIR:-$EUNOMIA_EXPORT_RUNNER_DIST_DIR}
if [ -z "$PLUGIN_EUNOMIA_EXPORT_RUNNER_DIST_DIR" ]; then
  export PLUGIN_EUNOMIA_EXPORT_RUNNER_DIST_DIR="/var/www/html"
fi
#
export PLUGIN_EUNOMIA_EXPORT_ID_DIR=${PLUGIN_EUNOMIA_EXPORT_DIR}/$PLUGIN_EUNOMIA_BUILD_ID
export PLUGIN_EUNOMIA_EXPORT_ID_PKG=${PLUGIN_EUNOMIA_EXPORT_ID_DIR}.tar.gz
#
export PLUGIN_EUNOMIA_NOTIFICATION_FEISHU_URL=https://open.feishu.cn/open-apis/bot/v2/hook/aecda9eb-84ca-4231-aaf6-bee02cc144b8

if [ -z "$PLUGIN_EUNOMIA_DOCKER_REGISTRY" ]; then
  log::error "[eunomia::build] PLUGIN_EUNOMIA_DOCKER_REGISTRY is required"
  return 1
fi

if [ ! -d "$PLUGIN_EUNOMIA_GIT_DIR" ]; then
  mkdir -p $PLUGIN_EUNOMIA_GIT_DIR
fi

if [ ! -d "$PLUGIN_EUNOMIA_BUILD_DIR" ]; then
  mkdir -p $PLUGIN_EUNOMIA_BUILD_DIR
fi

if [ ! -d "$PLUGIN_EUNOMIA_EXPORT_DIR" ]; then
  mkdir -p $PLUGIN_EUNOMIA_EXPORT_DIR
fi

if [ ! -d "$PLUGIN_EUNOMIA_LOG_DIR" ]; then
  mkdir -p $PLUGIN_EUNOMIA_LOG_DIR
fi

if [ ! -d "$PLUGIN_EUNOMIA_TMP_DIR" ]; then
  mkdir -p $PLUGIN_EUNOMIA_TMP_DIR
fi

# @TODO
if [ "$FLOW_CI" = "true" ]; then
  log::info "[$(timestamp)] Current CI: FLOW_CI"

  export PIPELINE_ID=$(echo $PIPELINE_ID | base64 -d)
  export BUILD_NUMBER=$(echo $BUILD_NUMBER | base64 -d)

  export EUNOMIA_TASK_ID=$(echo $EUNOMIA_TASK_ID | base64 -d)

  export EUNOMIA_GIT_BRANCH=$(echo $EUNOMIA_GIT_BRANCH | base64 -d)
  export EUNOMIA_GIT_REPOSITORY=$(echo $EUNOMIA_GIT_REPOSITORY | base64 -d)
  export EUNOMIA_GIT_COMMIT=$(echo $EUNOMIA_GIT_COMMIT | base64 -d)

  export EUNOMIA_DEPLOYMENT_MODE=$(echo $EUNOMIA_DEPLOYMENT_MODE | base64 -d)

  # @TODO new env
  export PLUGIN_EUNOMIA_BUILD_ID=${PIPELINE_ID}_${BUILD_NUMBER}
fi
